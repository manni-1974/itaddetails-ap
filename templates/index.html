<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Manufacturing Label Intake</title>
<style>
  :root{ --box:160px; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;background:#0b0f17;color:#e9eef7}
  h2{margin:0 0 6px}
  .small{color:#9fb0c7;font-size:13px;margin:6px 0 14px}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .card{background:#0f1522;border:1px solid #1b2740;border-radius:12px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.4)}
  .picker{display:flex;flex-direction:column;gap:8px}
  .box{width:var(--box);height:var(--box);border:2px dashed #334a78;border-radius:10px;background:#0b1220;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .box .ph{color:#7f95b5;font-size:13px}
  .box img{max-width:100%;max-height:100%;object-fit:contain}
  .fileInput{position:absolute;inset:0;opacity:0;cursor:pointer}
  input[type="text"]{background:#0b1220;border:1px solid #334a78;border-radius:8px;padding:10px 12px;color:#e9eef7;width:240px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #3b5cb3;background:#0b1220;color:#e9eef7;cursor:pointer;transition:opacity .15s ease, transform .06s ease}
  button:hover{transform:translateY(-1px)}
  button.primary{background:#2356ff;border-color:#2356ff;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:#0f1522}
  th,td{border:1px solid #1b2740;padding:8px 10px;text-align:left;font-size:14px;vertical-align:middle}
  th{background:#10192d}
  .hint{font-size:12px;color:#9fb0c7;margin-top:6px}
  .ok{color:#22c55e}
  .err{color:#f87171}
  pre{white-space:pre-wrap;background:#0f1522;padding:12px;border-radius:8px;border:1px solid #1b2740}
  .stack{display:flex;flex-direction:column;gap:8px}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
  .tag.working{background:#17335a;color:#9ec5ff;border:1px solid #2a58a3}
  .tag.fail{background:#3b0f12;color:#fecaca;border:1px solid #7f1d1d}
  .tag.ready{background:#12321e;color:#bbf7d0;border:1px solid #14532d}
  .row-ghost td{opacity:.7}
  .cellInput{
    width:100%;
    background:#0b1220;
    border:1px solid #334a78;
    color:#e9eef7;
    border-radius:6px;
    padding:6px 8px;
    font-size:14px;
  }
  .actions{
    display:flex;align-items:center;justify-content:space-between;margin-top:10px;margin-bottom:6px
  }
  .linkbtn{padding:10px 14px;border-radius:8px;border:1px solid #3b5cb3;background:#0b1220;color:#e9eef7;cursor:pointer;text-decoration:none;display:inline-block}
  .linkbtn:hover{transform:translateY(-1px)}
  .delbtn{
    display:inline-flex;align-items:center;justify-content:center;
    width:22px;height:22px;min-width:22px;
    margin-right:8px;border-radius:6px;border:1px solid #7f1d1d;
    background:#3b0f12;color:#fecaca;font-weight:900;line-height:1;cursor:pointer;
    user-select:none;
  }
  .delbtn:hover{ transform:translateY(-1px); }
  .rownum{ display:inline-block;min-width:16px;text-align:right; }
  td.idxcol{white-space:nowrap}
  .inlineFlex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div>
      <h2>AI Manufacturing Label Intake (Two Tag Photos → Row)</h2>
      <div class="small">
        Provide TWO photos of manufacturing/service tags (dark label + white sticker).
        The AI reads SN/Service Tag and uses OEM APIs. If unreadable, the row is blank and you can click <b>Add Serial No.</b>.
      </div>
    </div>
    <div><a class="linkbtn" href="/upload-db">Upload DB</a></div>
  </div>

  <div class="row" id="controlsRow">
    <div class="card picker">
      <div style="font-weight:600">Photo A — Tag / Label</div>
      <div class="box" id="boxA">
        <span class="ph">Tap to add</span>
        <input class="fileInput" type="file" id="fileA" accept="image/*">
      </div>
      <div class="hint">Dark manufacturing label (bottom cover) preferred.</div>
    </div>

    <div class="card picker">
      <div style="font-weight:600">Photo B — Tag / Label</div>
      <div class="box" id="boxB">
        <span class="ph">Tap to add</span>
        <input class="fileInput" type="file" id="fileB" accept="image/*">
      </div>
      <div class="hint">White service/serial sticker if present.</div>
    </div>

    <div class="card stack" style="min-width:280px">
      <div class="stack">
        <label for="orderInput" style="font-size:13px;color:#9fb0c7">Order No. (sticky)</label>
        <input id="orderInput" type="text" placeholder="e.g., 2025-IF-Ohio-Load-7" autocomplete="off">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="resetBtn"   type="button">Reset</button>

        <!-- NEW: model-only / serial-only buttons -->
        <button id="analyzeModelOnlyBtn" type="button">Analyze Model Only (Photo A)</button>
        <button id="analyzeSerialOnlyBtn" type="button">Analyze Serial Only (Photo B)</button>
        <!-- /NEW -->

        <button id="analyzeBtn" type="button" class="primary">Analyze</button>
      </div>
      <div class="hint" id="statusMsg" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="actions">
    <div></div>
    <button id="downloadCsvBtn" type="button">Download CSV (current rows)</button>
  </div>

  <table id="outTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Order No.</th>
        <th>Manufacturer</th>
        <th>Model</th>
        <th>Serial</th>
        <th>CPU</th>
        <th>RAM</th>
        <th>Status / Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <hr>
  <h3>Recent (last 10 saved)</h3>
  <pre>{{log}}</pre>

<script>
(function(){
  function byId(id){ return document.getElementById(id); }
  function normalizeSerial(v){ return (v||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }
  function setStatus(msg, isErr=false){
    const s = byId('statusMsg'); if(!s) return;
    s.textContent = msg || "";
    s.className = "hint " + (isErr ? "err" : "ok");
  }
  function rebuildBox(boxId, inputId){
    const box = byId(boxId);
    while(box.firstChild){ box.removeChild(box.firstChild); }
    const ph = document.createElement('span'); ph.className='ph'; ph.textContent='Tap to add';
    const input = document.createElement('input');
    input.className='fileInput'; input.type='file'; input.accept='image/*'; input.id = inputId;
    box.appendChild(ph); box.appendChild(input);
    input.addEventListener('change', ()=>{
      const f = input.files && input.files[0];
      const old = box.querySelector('img'); if(old) old.remove();
      const phE = box.querySelector('.ph'); if(phE) phE.remove();
      if(!f){
        if(!box.querySelector('.ph')){ const s=document.createElement('span'); s.className='ph'; s.textContent='Tap to add'; box.prepend(s); }
        return;
      }
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.onload = ()=> URL.revokeObjectURL(img.src);
      box.appendChild(img);
    });
    return input;
  }
  function hardResetUI(){
    rebuildBox('boxA','fileA');
    rebuildBox('boxB','fileB');
    setStatus("");
    const ab = byId('analyzeBtn'); if(ab) ab.disabled = false;
  }
  function getFilesSafe(){
    let fileA = byId('fileA'); if(!fileA) fileA = rebuildBox('boxA','fileA');
    let fileB = byId('fileB'); if(!fileB) fileB = rebuildBox('boxB','fileB');
    return { fileA, fileB };
  }

  let rowCount = 0;

  function makeStatusTag(kind, text){
    const span = document.createElement('span');
    span.className = 'tag ' + kind;
    span.textContent = text;
    return span;
  }

  function inputCell(value, placeholder){
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.className = 'cellInput';
    inp.value = value || '';
    if (placeholder) inp.placeholder = placeholder;
    return inp;
  }

  function renumberRows(){
    const rows = Array.from(byId('tbody').querySelectorAll('tr'));
    rows.forEach((tr, i)=>{
      const num = tr.querySelector('.rownum');
      if (num) num.textContent = String(i+1);
    });
  }

  function makeDeleteButton(tr){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'delbtn';
    btn.title = 'Remove this row';
    btn.setAttribute('aria-label','Remove row');
    btn.textContent = '×';
    btn.addEventListener('click', ()=>{
      tr.remove();
      renumberRows();
      setStatus('Row removed.');
    });
    return btn;
  }

  function addPendingRow(orderNo){
    rowCount += 1;
    const tr = document.createElement('tr');
    tr.className = 'row-ghost';

    // First cell: red X + number
    const tdIdx  = document.createElement('td'); tdIdx.className = 'idxcol';
    const del = makeDeleteButton(tr);
    const numSpan = document.createElement('span'); numSpan.className = 'rownum'; numSpan.textContent = rowCount;
    tdIdx.appendChild(del);
    tdIdx.appendChild(numSpan);

    const tdOrder= document.createElement('td'); tdOrder.textContent = orderNo || '';
    const tdMfr  = document.createElement('td'); tdMfr.textContent = '';
    const tdModel= document.createElement('td'); tdModel.textContent = '';
    const tdSN   = document.createElement('td'); tdSN.textContent = '';
    const tdCPU  = document.createElement('td'); tdCPU.textContent = '';
    const tdRAM  = document.createElement('td'); tdRAM.textContent = '';
    const tdAct  = document.createElement('td');

    const status = makeStatusTag('working','Analyzing…');
    tdAct.appendChild(status);

    tr.appendChild(tdIdx);
    tr.appendChild(tdOrder);
    tr.appendChild(tdMfr);
    tr.appendChild(tdModel);
    tr.appendChild(tdSN);
    tr.appendChild(tdCPU);
    tr.appendChild(tdRAM);
    tr.appendChild(tdAct);

    byId('tbody').appendChild(tr);

    return {
      tr, tdIdx, tdOrder, tdMfr, tdModel, tdSN, tdCPU, tdRAM, tdAct,
      setWorking(){
        tdAct.innerHTML=''; tdAct.appendChild(makeStatusTag('working','Analyzing…')); tr.classList.add('row-ghost');
      },
      setReady(j){
        tr.classList.remove('row-ghost');

        tdOrder.textContent = j.order_no || tdOrder.textContent || '';

        tdMfr.innerHTML  = ''; const inpMfr   = inputCell(j.manufacturer || '');
        tdModel.innerHTML= ''; const inpModel = inputCell((j.model_no || j.retail_model_guess || ''));
        tdSN.innerHTML   = ''; const inpSN    = inputCell(j.serial || '', 'Serial / Service Tag');
        tdCPU.innerHTML  = ''; const inpCPU   = inputCell(j.cpu || '');
        tdRAM.innerHTML  = ''; const inpRAM   = inputCell(j.ram || '');

        tdMfr.appendChild(inpMfr);
        tdModel.appendChild(inpModel);
        tdSN.appendChild(inpSN);
        tdCPU.appendChild(inpCPU);
        tdRAM.appendChild(inpRAM);

        tdAct.innerHTML     = '';
        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Confirm';

        btn.addEventListener('click', async ()=>{
          try{
            btn.disabled = true;
            const payload = {
              time: j.time,
              order_no: tdOrder.textContent || '',
              file_a: j.file_a || '', 
              file_b: j.file_b || '',
              manufacturer: inpMfr.value.trim(),
              model_no:     inpModel.value.trim(),
              serial:       (inpSN.value || '').trim().toUpperCase(),
              cpu:          inpCPU.value.trim(),
              ram:          inpRAM.value.trim(),
              product_no:   j.product_no || '',
              reg_model:    j.reg_model || '',
              reg_type:     j.reg_type || '',
              dpn:          j.dpn || '',
              input_power:  j.input_power || '',
              retail_model_guess: j.retail_model_guess || '',
              notes:        j.notes || '',
              raw_json:     j.raw_json || ''
            };
            const rr = await fetch('/confirm_row', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            const jj = await rr.json().catch(()=> ({}));
            if(!rr.ok){ btn.disabled = false; throw new Error((jj && (jj.detail||jj.error)) || `HTTP ${rr.status}`); }
            tdAct.innerHTML = '';
            tdAct.appendChild(makeStatusTag('ready','Saved'));
            setStatus('Saved. You can keep adding laptops.');
          }catch(e){
            tdAct.innerHTML = '';
            const fail = makeStatusTag('fail','Save failed');
            tdAct.appendChild(fail);
            const retry = document.createElement('button');
            retry.style.marginLeft='8px';
            retry.textContent='Retry Save';
            retry.addEventListener('click', ()=> btn.click());
            tdAct.appendChild(retry);
          }
        });
        tdAct.appendChild(btn);
      },
      setNeedsSerial(jBase){
        tr.classList.remove('row-ghost');
        tdMfr.innerHTML = '';
        tdModel.innerHTML = '';
        tdSN.innerHTML = '';
        tdCPU.innerHTML = '';
        tdRAM.innerHTML = '';
        tdAct.innerHTML = '';

        const serialBox = inputCell('', 'Enter Serial / Service Tag');
        serialBox.style.width = '220px';

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Serial No.';
        addBtn.className = 'primary';

        const status = document.createElement('span');
        status.className = 'hint';
        status.style.marginLeft = '8px';

        const inline = document.createElement('div');
        inline.className = 'inlineFlex';
        inline.appendChild(serialBox);
        inline.appendChild(addBtn);
        inline.appendChild(status);
        tdAct.appendChild(inline);

        addBtn.addEventListener('click', async ()=>{
          const s = normalizeSerial(serialBox.value);
          if(!s){ status.textContent = 'Enter a serial/service tag first.'; return; }
          addBtn.disabled = true; status.textContent = 'Looking up…';
          try{
            const r = await fetch('/manual_serial_lookup', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({serial: s})
            });
            const j = await r.json().catch(()=> ({}));
            addBtn.disabled = false;
            if(!r.ok){ throw new Error((j && (j.detail||j.error)) || `HTTP ${r.status}`); }
            if(!(j && (j.manufacturer || j.model_no || j.cpu || j.ram))){
              status.textContent = 'No OEM data found. Check the serial.';
              return;
            }
            const merged = Object.assign({}, jBase, {
              manufacturer: j.manufacturer || '',
              model_no: j.model_no || '',
              cpu: j.cpu || '',
              ram: j.ram || '',
              serial: j.serial || s
            });

            tr.classList.add('row-ghost');
            setTimeout(()=> obj.setReady(merged), 0);
          }catch(e){
            addBtn.disabled = false;
            status.textContent = 'Lookup failed: ' + e.message;
          }
        });

        const obj = { setReady: null };
        obj.setReady = (j)=> {
          tdAct.innerHTML = '';
          tdMfr.innerHTML  = ''; const inpMfr   = inputCell(j.manufacturer || '');
          tdModel.innerHTML= ''; const inpModel = inputCell((j.model_no || j.retail_model_guess || ''));
          tdSN.innerHTML   = ''; const inpSN    = inputCell(j.serial || '', 'Serial / Service Tag');
          tdCPU.innerHTML  = ''; const inpCPU   = inputCell(j.cpu || '');
          tdRAM.innerHTML  = ''; const inpRAM   = inputCell(j.ram || '');
          tdMfr.appendChild(inpMfr);
          tdModel.appendChild(inpModel);
          tdSN.appendChild(inpSN);
          tdCPU.appendChild(inpCPU);
          tdRAM.appendChild(inpRAM);

          const btn = document.createElement('button');
          btn.className = 'primary';
          btn.textContent = 'Confirm';
          btn.addEventListener('click', async ()=>{
            try{
              btn.disabled = true;
              const payload = {
                time: jBase.time,
                order_no: tdOrder.textContent || '',
                file_a: jBase.file_a || '',
                file_b: jBase.file_b || '',
                manufacturer: inpMfr.value.trim(),
                model_no:     inpModel.value.trim(),
                serial:       (inpSN.value || '').trim().toUpperCase(),
                cpu:          inpCPU.value.trim(),
                ram:          inpRAM.value.trim(),
                product_no:   jBase.product_no || '',
                reg_model:    jBase.reg_model || '',
                reg_type:     jBase.reg_type || '',
                dpn:          jBase.dpn || '',
                input_power:  jBase.input_power || '',
                retail_model_guess: jBase.retail_model_guess || '',
                notes:        jBase.notes || '',
                raw_json:     jBase.raw_json || ''
              };
              const rr = await fetch('/confirm_row', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
              });
              const jj = await rr.json().catch(()=> ({}));
              if(!rr.ok){ btn.disabled = false; throw new Error((jj && (jj.detail||jj.error)) || `HTTP ${rr.status}`); }
              tdAct.innerHTML = '';
              tdAct.appendChild(makeStatusTag('ready','Saved'));
              setStatus('Saved. You can keep adding laptops.');
            }catch(e){
              tdAct.innerHTML = '';
              const fail = makeStatusTag('fail','Save failed');
              tdAct.appendChild(fail);
              const retry = document.createElement('button');
              retry.style.marginLeft='8px';
              retry.textContent='Retry Save';
              retry.addEventListener('click', ()=> btn.click());
              tdAct.appendChild(retry);
            }
          });
          tdAct.appendChild(btn);
        };

        tdMfr.textContent = '—';
        tdModel.textContent = '—';
        tdSN.textContent = '(waiting)';
        tdCPU.textContent = '—';
        tdRAM.textContent = '—';
      },
      setFailed(message){
        tr.classList.remove('row-ghost');
        tdAct.innerHTML = '';
        const fail = makeStatusTag('fail','Failed');
        tdAct.appendChild(fail);
        const msg = document.createElement('span');
        msg.style.marginLeft='8px'; msg.style.fontSize='12px'; msg.style.opacity='.9';
        msg.textContent = message || 'Analyze failed';
        tdAct.appendChild(msg);
      }
    };
  }

  function tableToCSV(){
    const tbody = byId('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const headers = ['#','Order No.','Manufacturer','Model','Serial','CPU','RAM','Status'];
    const data = [headers];

    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if (tds.length < 8) return;
      const idxSpan = tds[0].querySelector('.rownum');
      const idx = idxSpan ? idxSpan.textContent.trim() : (tds[0].textContent || '').trim();

      function val(td){
        const inp = td.querySelector('input.cellInput');
        if (inp) return inp.value;
        return (td.textContent || '').trim();
      }
      const order = val(tds[1]);
      const mfr   = val(tds[2]);
      const model = val(tds[3]);
      const sn    = val(tds[4]);
      const cpu   = val(tds[5]);
      const ram   = val(tds[6]);
      const stat  = (tds[7].textContent || '').replace(/\s+/g,' ').trim();
      data.push([idx,order,mfr,model,sn,cpu,ram,stat]);
    });

    const csv = data.map(row => row.map(cell=>{
      const c = (cell ?? '').toString();
      if (/[",\n]/.test(c)) return `"${c.replace(/"/g,'""')}"`;
      return c;
    }).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.href = url;
    a.download = `scans_session_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // ---- NEW: model-only flow (Photo A) ----
  async function analyzeModelOnly() {
    try{
      let fileA = byId('fileA'); if(!fileA) fileA = rebuildBox('boxA','fileA');
      const f = fileA.files && fileA.files[0];
      if(!f){ setStatus("Add Photo A (model/brand) first.", true); return; }

      const orderNo = (byId('orderInput').value || '').trim();

      const row = addPendingRow(orderNo);
      row.setWorking();

      // reset pickers but keep order no sticky
      hardResetUI();
      byId('orderInput').value = orderNo;
      setStatus("Queued. You can add the next device while this analyzes.");

      const fd = new FormData();
      fd.append('file_model', f);
      if (orderNo) fd.append('order_no', orderNo);

      const r = await fetch('/analyze_model', { method:'POST', body: fd });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error((j && (j.detail||j.error)) || `HTTP ${r.status}`);

      const shaped = Object.assign({}, j, { file_a: j.file_model || '', file_b: j.file_serial || '' });
      row.setReady(shaped);
      setStatus("Model ready. Now add Serial (Analyze Serial Only) or type it and Confirm.");
    }catch(e){
      setStatus("Model analyze failed: " + e.message, true);
      const row = addPendingRow(byId('orderInput').value || '');
      row.setFailed(e.message);
    }
  }

  // ---- NEW: serial-only flow (Photo B) ----
  async function analyzeSerialOnly() {
    try{
      let fileB = byId('fileB'); if(!fileB) fileB = rebuildBox('boxB','fileB');
      const f = fileB.files && fileB.files[0];
      if(!f){ setStatus("Add Photo B (serial sticker) first.", true); return; }

      const orderNo = (byId('orderInput').value || '').trim();

      const rows = Array.from(byId('tbody').querySelectorAll('tr'));
      const last = rows[rows.length - 1];
      if(!last){
        setStatus("No row exists yet. Run Analyze Model Only (Photo A) first.", true);
        return;
      }

      const fd = new FormData();
      fd.append('file_serial', f);
      if (orderNo) fd.append('order_no', orderNo);

      const r = await fetch('/analyze_serial', { method:'POST', body: fd });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error((j && (j.detail||j.error)) || `HTTP ${r.status}`);

      const tdList = last.querySelectorAll('td');
      const serialCell = tdList && tdList[4];
      if(serialCell){
        const input = serialCell.querySelector('input.cellInput');
        if(input){
          input.value = (j.serial || '').toUpperCase();
          setStatus(j.serial ? "Serial captured." : "Could not read serial — type it and Confirm.");
        }else{
          setStatus("Serial read. If it isn't visible, type it manually and Confirm.", true);
        }
      }else{
        setStatus("Serial read but table structure not found. Type it manually.", true);
      }

      // reset only Photo B so you can rapidly scan next sticker
      rebuildBox('boxB','fileB');
    }catch(e){
      setStatus("Serial analyze failed: " + e.message, true);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    hardResetUI();
    const analyzeBtn    = byId('analyzeBtn');
    const resetBtn      = byId('resetBtn');
    const downloadBtn   = byId('downloadCsvBtn');
    const orderInput    = byId('orderInput');

    const analyzeModelOnlyBtn  = byId('analyzeModelOnlyBtn');
    const analyzeSerialOnlyBtn = byId('analyzeSerialOnlyBtn');

    resetBtn.addEventListener('click', hardResetUI);
    downloadBtn.addEventListener('click', tableToCSV);

    analyzeModelOnlyBtn.addEventListener('click', analyzeModelOnly);
    analyzeSerialOnlyBtn.addEventListener('click', analyzeSerialOnly);

    // Your original pair flow remains unchanged
    analyzeBtn.addEventListener('click', async () => {
      try{
        const { fileA, fileB } = getFilesSafe();
        if(!(fileA.files && fileA.files[0]) || !(fileB.files && fileB.files[0])){
          setStatus("Please add both tag photos before analyzing.", true);
          return;
        }
        const orderNo = (orderInput.value || '').trim();

        const fa = fileA.files[0];
        const fb = fileB.files[0];

        const row = addPendingRow(orderNo);
        row.setWorking();

        hardResetUI();
        orderInput.value = orderNo; // keep sticky
        setStatus("Queued. You can add the next device while this analyzes.");

        const fd = new FormData();
        fd.append('fileA', fa);
        fd.append('fileB', fb);
        if (orderNo) fd.append('order_no', orderNo);

        const r = await fetch('/analyze_pair', { method:'POST', body: fd });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok){ throw new Error((j && (j.detail||j.error)) || `HTTP ${r.status}`); }

        const hasSerial = !!(j && j.serial);
        const hasAnyDevice = (j && (j.manufacturer || j.model_no || j.cpu || j.ram));
        if (!hasSerial && !hasAnyDevice) {
          const base = Object.assign({
            time: j.time,
            order_no: j.order_no || orderNo,
            file_a: j.file_a,
            file_b: j.file_b,
            product_no: '',
            reg_model: '',
            reg_type: '',
            dpn: '',
            input_power: '',
            retail_model_guess: '',
            notes: '',
            raw_json: j.raw_json || ''
          }, {});
          row.setNeedsSerial(base);
        } else {
          row.setReady(j);
        }
      }catch(e){
        setStatus("Analyze failed: " + e.message, true);
        const row = addPendingRow(byId('orderInput').value || '');
        row.setFailed(e.message);
      }
    });
  });
})();
</script>
</body>
</html>

